---
title: "Bayesian modeling and prediction for movies"
author: "Raymond Ngiam"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(statsr)
library(BAS)
library(GGally)
library(MASS)
```

### Load data

```{r load-data}
load("movies.Rdata")
```



* * *

## Part 1: Data

**How the observations in the sample are collected:**

The data set is comprised of 651 randomly sampled movies produced and released before 2016.
<br></br>

**Implications of this data collection method on the scope of inference (generalizability):**

Since the data collection involves random sampling, the sample can be considered representative of the population. Hence findings from this observational study can be generalized to the entire population.
<br></br>

**Implications of this data collection method on the scope of inference (causality):**

Since this is an observational study, not an experiment where subjects are randomly assigned for specific treatments, hence, the findings on relationship among different factors only establish association but do not imply causality.

* * *

## Part 2: Data manipulation

Entries with NA (Not Applicable) cell are removed from the dataset.
```{r}
movies_no_na <- na.omit(movies)
N = nrow(movies_no_na)
N
```

New variables are created as follows:

+ **feature_film**: "yes" if **title_type** is Feature Film, "no" otherwise
+ **drama**: "yes" if **genre** is Drama, "no" otherwise
+ **mpaa_rating_R**: "yes" if **mpaa_rating** is R, "no" otherwise
+ **oscar_season**: "yes" if movie is released in November, October, or December (based on **thtr_rel_month**), "no" otherwise
+ **summer_season**: "yes" if movie is released in May, June, July, or August (based on **thtr_rel_month**), "no" otherwise 

```{r}
movies_added_predictors <- movies_no_na %>%
  mutate(feature_film = if_else(title_type=="Feature Film","yes","no")) %>%
  mutate(drama = if_else(genre=="Drama","yes","no")) %>%
  mutate(mpaa_rating_R = if_else(mpaa_rating=="R","yes","no")) %>%
  mutate(oscar_season = if_else(is.element(thtr_rel_month,c(10,11,12)),"yes","no")) %>%
  mutate(summer_season = if_else(is.element(thtr_rel_month,c(5,6,7,8)),"yes","no"))

movies_added_predictors$feature_film = factor(movies_added_predictors$feature_film, levels = c("yes", "no"))
movies_added_predictors$drama = factor(movies_added_predictors$drama, levels = c("yes", "no"))
movies_added_predictors$mpaa_rating_R = factor(movies_added_predictors$mpaa_rating_R, levels = c("yes", "no"))
movies_added_predictors$oscar_season = factor(movies_added_predictors$oscar_season, levels = c("yes", "no"))
movies_added_predictors$summer_season = factor(movies_added_predictors$summer_season, levels = c("yes", "no"))
```

* * *

## Part 3: Exploratory data analysis

We will consider the following variables in our bayesian model selection:

+ **feature_film**
+ **drama**
+ **runtime**
+ **mpaa_rating_R**
+ **thtr_rel_year**
+ **oscar_season**
+ **summer_season**
+ **imdb_rating**
+ **imdb_num_votes**
+ **critics_score**
+ **best_pic_nom**
+ **best_pic_win**
+ **best_actor_win**
+ **best_actress_win**
+ **best_dir_win**
+ **top200_box**

Firstly, lets explore the relationship between audience_score and the new categorical variables constructed in the previous part.

1) Feature film and audience score

Box plot to visualize the differences in audience score distribution among categorical variable, **feature_film**.
```{r}
ggplot(data=movies_added_predictors, aes(x=feature_film, y=audience_score)) + 
  geom_boxplot() + 
  labs(title = "Boxplot of audience_score against feature_film")
```

Summary statistics
```{r}
movies_added_predictors %>%
  group_by(feature_film) %>%
  summarize(mean=mean(audience_score), sd=sd(audience_score),median=median(audience_score),IQR=IQR(audience_score),min=min(audience_score),max=max(audience_score), count=n())
```

<span style="color:blue">Interpretation: There is an obvious difference in the distribution of audience score between movies that belong to </span>
<span style="color:blue;font-weight:bold">feature_film</span>
<span style="color:blue"> category and those that do not. The </span>
<span style="color:blue;font-weight:bold">feature_film</span>
<span style="color:blue"> title type has lower audience score by 21.966 on average compared to the rest.</span>
<br> </br>

2) Drama and audience score

Box plot to visualize the differences in audience score distribution among categorical variable, **drama**.
```{r}
ggplot(data=movies_added_predictors, aes(x=drama, y=audience_score)) + 
  geom_boxplot() + 
  labs(title = "Boxplot of audience_score against drama")
```

Summary statistics
```{r}
movies_added_predictors %>%
  group_by(drama) %>%
  summarize(mean=mean(audience_score), sd=sd(audience_score),median=median(audience_score),IQR=IQR(audience_score),min=min(audience_score),max=max(audience_score), count=n())
```

<span style="color:blue">Interpretation: There is an obvious difference in the distribution of audience score between movies that belong to </span>
<span style="color:blue;font-weight:bold">drama</span>
<span style="color:blue"> category and those that do not. The </span>
<span style="color:blue;font-weight:bold">drama</span>
<span style="color:blue"> genre has higher audience score by 5.937 on average compared to the rest.</span>
<br> </br>

3) MPAA R Rating and audience score

Box plot to visualize the differences in audience score distribution among categorical variable, **mpaa_rating_R**.
```{r}
ggplot(data=movies_added_predictors, aes(x=mpaa_rating_R, y=audience_score)) + 
  geom_boxplot() + 
  labs(title = "Boxplot of audience_score against mpaa_rating_R")
```

Summary statistics
```{r}
movies_added_predictors %>%
  group_by(mpaa_rating_R) %>%
  summarize(mean=mean(audience_score), sd=sd(audience_score),median=median(audience_score),IQR=IQR(audience_score),min=min(audience_score),max=max(audience_score), count=n())
```

<span style="color:blue">Interpretation: Apparently there is close to no difference in the distribution of audience score between movies that belong to </span>
<span style="color:blue;font-weight:bold">mpaa_rating_R</span>
<span style="color:blue"> category and those that do not. The difference of average audience score between the two classes is only 0.336, hence it is not a significant predictor.</span>
<br> </br>

4) Oscar season and audience score

Box plot to visualize the differences in audience score distribution among categorical variable, **oscar_season**.
```{r}
ggplot(data=movies_added_predictors, aes(x=oscar_season, y=audience_score)) + 
  geom_boxplot() + 
  labs(title = "Boxplot of audience_score against oscar_season")
```

Summary statistics
```{r}
movies_added_predictors %>%
  group_by(oscar_season) %>%
  summarize(mean=mean(audience_score), sd=sd(audience_score),median=median(audience_score),IQR=IQR(audience_score),min=min(audience_score),max=max(audience_score), count=n())
```

<span style="color:blue">Interpretation: There is an obvious difference in the distribution of audience score between movies that are released on </span>
<span style="color:blue;font-weight:bold">oscar_season</span>
<span style="color:blue"> and those that are not. The movies that are released on </span>
<span style="color:blue;font-weight:bold">oscar_season</span>
<span style="color:blue"> has higher audience score by 2.322 on average compared to the rest.</span>
<br> </br>

5) Summer season and audience score

Box plot to visualize the differences in audience score distribution among categorical variable, **summer_season**.
```{r}
ggplot(data=movies_added_predictors, aes(x=summer_season, y=audience_score)) + 
  geom_boxplot() + 
  labs(title = "Boxplot of audience_score against summer_season")
```

Summary statistics
```{r}
movies_added_predictors %>%
  group_by(summer_season) %>%
  summarize(mean=mean(audience_score), sd=sd(audience_score),median=median(audience_score),IQR=IQR(audience_score),min=min(audience_score),max=max(audience_score), count=n())
```

<span style="color:blue">Interpretation: Apparently there is close to no difference in the distribution of audience score between movies that are released on </span>
<span style="color:blue;font-weight:bold">summer_season</span>
<span style="color:blue"> and those that are not. The difference of average audience score between the two classes is only 0.532, hence it is not a significant predictor.</span>
<br> </br>

Next, we will analyze the numeric explanatory variables, namely **runtime**, **thtr_rel_year**, **imdb_rating**, **imdb_num_votes**, and **critics score**. Out of these five variables, **imdb_num_votes** is of particular interest.

Below is the histogram for the distribution of **imdb_num_votes**,

```{r}
ggplot(data = movies_added_predictors, aes(x=imdb_num_votes)) +
  geom_histogram(binwidth = 1500) +
  labs(title = "Histogram of imdb_num_votes")
range(movies_added_predictors$imdb_num_votes)
```

The range of **imdb_num_votes** is (183, 893008), and it is heavily right-skewed. It will be more meaningful if we apply a log transformation, and name it as a new variable, **limdb_num_votes**.

```{r}
movies_added_predictors <- movies_added_predictors %>%
  mutate(limdb_num_votes = log10(imdb_num_votes))
```

Histogram of **limdb_num_votes**
```{r}
ggplot(data = movies_added_predictors, aes(x=limdb_num_votes)) +
  geom_histogram(binwidth = 0.1) +
  labs(title = "Histogram of limdb_num_votes")
```
<br> </br>

Next, we will explore the correlation among the five numeric explanatory variables.

```{r}
ggpairs(dplyr::select(movies_added_predictors,runtime, thtr_rel_year,limdb_num_votes,imdb_rating,critics_score),title = "Pairwise relationships among numeric explanatory variables")
```

<br> </br>

We observed that **imdb_rating** and **critics_score** are highly correlated with correlation coefficient of 0.762, while the rest are not as correlated. Since the two variables are measure of the movie's popularity, we can compute a weighted average from the two variables to form a new variable **score**. 

Since **imdb_rating** is of the range (0,10) and **critics_score** is of the range (0,100), we reweight them by multiply **imdb_rating** with weight 10, and **critics_score** with weight 1, then taking the average of both. The final **score** variable will be of the range (0,100).

```{r}
movies_added_predictors <- movies_added_predictors %>%
  mutate(score = (imdb_rating*10+critics_score)/2)
```
* * *

## Part 4: Modeling

**Bayesian Model Selection using Bayesian Information Criterion (BIC)** 

Continue from our explanatory data analysis, we ended up with **13** explanatory variables as listed below. We will use these updated explanatory variables as the full model for our model selection under BIC: 

+ **feature_film**
+ **drama**
+ **runtime**
+ <span style="text-decoration:line-through">mpaa_rating_R</span>
+ **thtr_rel_year**
+ **oscar_season**
+ <span style="text-decoration:line-through">summer_season</span>
+ <span style="text-decoration:line-through">imdb_rating</span> 
<span style="color:blue;font-weight:bold">score</span>
+ <span style="text-decoration:line-through">imdb_num_votes</span> 
<span style="color:blue;font-weight:bold">limdb_num_votes</span>
+ <span style="text-decoration:line-through">critics_score</span>
+ **best_pic_nom**
+ **best_pic_win**
+ **best_actor_win**
+ **best_actress_win**
+ **best_dir_win**
+ **top200_box**

```{r}
data_train<-movies_added_predictors %>%
  dplyr::select(audience_score,feature_film,drama,runtime,thtr_rel_year,oscar_season,score,limdb_num_votes,best_pic_nom,best_pic_win,best_actor_win,best_actress_win,best_dir_win,top200_box)
modelFull = lm(audience_score ~ ., data=data_train)

BICmodel<-stepAIC(modelFull,k=log(N))
summary(BICmodel)
```

<span style="color:blue">The final model includes explanatory variables</span> 
<span style="color:blue;font-weight:bold">feature_film, score</span>
<span style="color:blue"> and</span> 
<span style="color:blue;font-weight:bold">limdb_num_votes. </span>
<span style="color:blue">63.03% of the variability of the audience score is explained by this model.</span>

<br> </br>

**Model Diagnostics**

```{r}
par(mfrow=c(2,2))
plot(BICmodel)
```

<span style="text-decoration:underline">Linearity:</span>

<span style="color:blue">Random scatter around zero in residuals vs fitted plot. Hence relationship between response variable and explanatory variables should be linear.</span>

<span style="text-decoration:underline">Nearly normal residuals:</span>

Histogram of residual

```{r}
par(mfrow=c(1,1))
plot(density(BICmodel$resid))
```

<span style="color:blue">From the normal probability plot and histogram of residual, the condition for nearly normal residuals is satisfied.</span>

<span style="text-decoration:underline">Constant variability:</span>

<span style="color:blue">From the residuals vs fitted plot, the condition for constant variability is also satisfied.</span>

<br> </br>

**Bayesian model selection using Bayesian Model Averaging (BMA)**

BMA is created using bas.lm function from the BAS package.

```{r}
set.seed(5)
bma_audience_score = bas.lm(audience_score ~ ., 
                   prior = "BIC", 
                   modelprior = uniform(),
                   data=data_train)
bma_audience_score
summary(bma_audience_score)
```

Diagnostic plots for the BMA

```{r}
par(mfrow=c(2,2)) 
plot(bma_audience_score,ask=F)
```

Visualization of model uncertainty

```{r}
par(mfrow=c(1,1)) 
image(bma_audience_score,rotate=F)
```

<span style="color:blue">The highest probability model in the BMA corresponds to the model selected via BIC in the previous part. It has posterior probability of 25.72% from a total of $2^{13} = 8196$ possible models.</span>

```{r}
HPM_pred_audience_score = predict(bma_audience_score, estimator="HPM",se.fit=TRUE)
bma_audience_score$namesx[HPM_pred_audience_score$bestmodel+1]
```

* * *

## Part 5: Prediction

NOTE: Insert code chunks as needed by clicking on the "Insert a new code chunk" 
button above. Make sure that your code is visible in the project you submit. 
Delete this note when before you submit your work.

* * *

## Part 6: Conclusion

